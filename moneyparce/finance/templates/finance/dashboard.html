{% extends 'base.html' %}

{% block content %}
<div class="container mt-4 mb-5">
    <h2>Welcome, {{ user.username }}</h2>
    <p>Your personalized finance dashboard.</p>

    <!-- Filter Section -->
    <form method="get">
        <div class="row">
            <div class="col-md-4">
                <label for="year">Year:</label>
                <select name="year" id="year" class="form-control">
                    <option value="">All Years</option>
                    <option value="2025" {% if year_filter == '2025' %}selected{% endif %}>2025</option>
                    <option value="2024" {% if year_filter == '2024' %}selected{% endif %}>2024</option>
                    <!-- Add more years as needed -->
                </select>
            </div>

            <div class="col-md-4">
                <label for="month">Month:</label>
                <select name="month" id="month" class="form-control">
                    <option value="">All Months</option>
                    <option value="1" {% if month_filter == '1' %}selected{% endif %}>January</option>
                    <option value="2" {% if month_filter == '2' %}selected{% endif %}>February</option>
                    <option value="3" {% if month_filter == '3' %}selected{% endif %}>March</option>
                    <option value="4" {% if month_filter == '4' %}selected{% endif %}>April</option>
                    <option value="5" {% if month_filter == '5' %}selected{% endif %}>May</option>
                    <option value="6" {% if month_filter == '6' %}selected{% endif %}>June</option>
                    <option value="7" {% if month_filter == '7' %}selected{% endif %}>July</option>
                    <option value="8" {% if month_filter == '8' %}selected{% endif %}>August</option>
                    <option value="9" {% if month_filter == '9' %}selected{% endif %}>September</option>
                    <option value="10" {% if month_filter == '10' %}selected{% endif %}>October</option>
                    <option value="11" {% if month_filter == '11' %}selected{% endif %}>November</option>
                    <option value="12" {% if month_filter == '12' %}selected{% endif %}>December</option>
                </select>
            </div>

            <div class="col-md-4">
                <label for="category">Category:</label>
                <select name="category" id="category" class="form-control">
                    <option value="">All Categories</option>
                    <option value="income" {% if category_filter == 'income' %}selected{% endif %}>Income</option>
                    <option value="food" {% if category_filter == 'food' %}selected{% endif %}>Food</option>
                    <option value="rent" {% if category_filter == 'rent' %}selected{% endif %}>Rent</option>
                    <option value="entertainment" {% if category_filter == 'entertainment' %}selected{% endif %}>Entertainment</option>
                    <option value="misc" {% if category_filter == 'misc' %}selected{% endif %}>Miscellaneous</option>
                </select>
            </div>
        </div>
        <button type="submit" class="btn btn-success mt-3">Apply Filters</button>
    </form>

    <!-- Space between Apply Filters and Budget Overview -->
    <div style="margin-top: 20px;"></div>

    <!-- Charts Section -->
    <div class="chart-row mt-4">
        <div class="chart-half">
            <div class="chart-container" id="categoryChart"></div>
        </div>
        <div class="chart-half">
            <div class="chart-container" id="budgetChart"></div>
        </div>
    </div>
    <div class="chart-container" id="timeChart"></div>

    <!-- Display the user's budget information -->
    {% if monthly_budget %}
    <div class="budget-info">
        <h3>Your Budget Overview</h3>
        <p>Your current monthly budget: ${{ monthly_budget }}</p>
        <p>Max amount you should have spent this month so far: ${{ target_spending|floatformat:2 }}</p>
        <p>Your current spending this month: ${{ monthly_spending|floatformat:2 }}</p>
        <p>{{ budget_status }}</p>
    </div>
    {% else %}
    <div class="budget-info">
        <h3>You haven't set a budget yet.</h3>
    </div>
    {% endif %}

    <!-- Space between Budget Overview and Recent Transactions -->
    <div style="margin-bottom: 20px;"></div>

    <div class="row mt-4">
        <div class="col-md-6">
            <h4>Your Recent Transactions</h4>
            <ul>
                {% for transaction in transactions %}
                <li>{{ transaction.description }} - ${{ transaction.amount }} ({{ transaction.fake_date }})</li>
                {% empty %}
                <li>No transactions yet.</li>
                {% endfor %}
            </ul>
        </div>

        <div class="col-md-6">
            <h4>Add New Transaction</h4>
            <form method="post">
                {% csrf_token %}
                <div class="form-group">
                    <label for="amount">Amount:</label>
                    <input type="number" name="amount" class="form-control" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="category">Category:</label>
                    <select name="category" class="form-control" required>
                        <option value="income">Income</option>
                        <option value="food">Food</option>
                        <option value="rent">Rent</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="misc">Miscellaneous</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="description">Description:</label>
                    <input type="text" name="description" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="recurring">Recurring:</label>
                    <select name="recurring" class="form-control" required>
                        <option value="one_time">None</option>
                        <option value="weekly">Weekly</option>
                        <option value="biweekly">Biweekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-success mt-3">Add Transaction</button>
            </form>
        </div>
    </div>
</div>

<!-- Budget Setting Section -->
<form method="POST" action="{% url 'finance:set_budget' %}">
    {% csrf_token %}
    <div class="form-group">
        <label for="amount">Maximum Monthly Budget ($):</label>
        <input type="number" step="0.01" name="amount" class="form-control" id="amount" value="{{ form.amount.value }}" required>
    </div>

    <div class="form-group">
        <label for="description">Description (Optional):</label>
        <textarea name="description" class="form-control" id="description" rows="3">{{ form.description.value }}</textarea>
    </div>

    <button type="submit" class="btn btn-primary">Set Budget</button>
</form>
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
    // First load the charts library
    google.charts.load('current', {'packages':['corechart']});

    // Then set callback
    google.charts.setOnLoadCallback(function() {
        // Check if chart containers exist before drawing
        if (document.getElementById('categoryChart')) {
            drawCategoryChart();
        }
        if (document.getElementById('budgetChart') && {{ budget_progress_data|length }} > 0) {
            drawBudgetChart();
        }
        if (document.getElementById('timeChart')) {
            drawTimeChart();
        }
    });

    function drawCategoryChart() {
        var data = google.visualization.arrayToDataTable({{ chart_data|safe }});
        var options = {
            title: 'Spending by Category',
            pieSliceText: 'value',
            backgroundColor: 'transparent',
            legend: {position: 'right'},
            chartArea: {width: '80%', height: '80%'}
        };
        var chart = new google.visualization.PieChart(document.getElementById('categoryChart'));
        chart.draw(data, options);
    }

    function drawBudgetChart() {
        var data = google.visualization.arrayToDataTable({{ budget_progress_data|safe }});
        var options = {
            title: 'Budget Progress',
            pieHole: 0.4,
            pieSliceText: 'value',
            backgroundColor: 'transparent',
            chartArea: {width: '80%', height: '80%'},
            slices: {
                0: { color: '#e7711c' },
                1: { color: '#1c91c0' }
            }
        };
        var chart = new google.visualization.PieChart(document.getElementById('budgetChart'));
        chart.draw(data, options);
    }

    function drawTimeChart() {
        var data = google.visualization.arrayToDataTable({{ time_chart_data|safe }});
        var options = {
            title: 'Spending Over Time',
            curveType: 'function',
            legend: { position: 'bottom' },
            backgroundColor: 'transparent',
            chartArea: {width: '85%', height: '70%'},
            hAxis: { title: 'Date' },
            vAxis: {
                title: 'Amount',
                minValue: 0,
                viewWindow: { min: 0 }
            }
        };
        var chart = new google.visualization.LineChart(document.getElementById('timeChart'));
        chart.draw(data, options);
    }

    // Handle window resize
    window.addEventListener('resize', function() {
        if (typeof drawCategoryChart === 'function') drawCategoryChart();
        if (typeof drawBudgetChart === 'function') drawBudgetChart();
        if (typeof drawTimeChart === 'function') drawTimeChart();
    });
</script>
{% endblock %}